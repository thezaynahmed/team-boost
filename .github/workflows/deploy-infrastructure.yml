name: Deploy Team-Boost Infrastructure and Application

# NOTE: Auto-deploy disabled until Azure quota is approved.
# To re-enable, uncomment the push and pull_request triggers below.
on:
  # push:
  #   branches: [ main, dev ]
  #   paths:
  #     - 'infrastructure/**'
  #     - '.github/workflows/deploy-infrastructure.yml'
  # pull_request:
  #   branches: [ main, dev ]
  #   paths:
  #     - 'infrastructure/**'
  #     - '.github/workflows/deploy-infrastructure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP_DEV: teamboost-rg-dev
  AZURE_RESOURCE_GROUP_PROD: teamboost-rg-prod
  AZURE_LOCATION: East US

jobs:
  validate:
    name: Validate Infrastructure Templates
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Team-Boost code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Validate Dev Template
      run: |
        cd infrastructure/bicep_v2
        az deployment group validate \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
          --template-file main.bicep \
          --parameters @parameters.dev.json

    - name: Validate Prod Template
      if: github.ref == 'refs/heads/main'
      run: |
        cd infrastructure/bicep_v2
        az deployment group validate \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
          --template-file main.bicep \
          --parameters @parameters.prod.json

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    environment: development

    steps:
    - name: Checkout Team-Boost code
      uses: actions/checkout@v4

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
          --location "${{ env.AZURE_LOCATION }}" \
          --tags Environment=dev Application=team-boost ManagedBy=GitHub-Actions

    - name: Deploy Infrastructure
      id: deploy-infra
      run: |
        cd infrastructure/bicep_v2
        
        echo "=== DEBUG: FILE CONTENT ==="
        ls -la
        grep "cosmosContainerName" main.bicep
        grep "excludedPaths" main.bicep -A 5
        echo "==========================="

        DEPLOYMENT_NAME="teamboost-dev-deployment-$(date +%Y%m%d-%H%M%S)"

        az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
          --template-file main.bicep \
          --parameters @parameters.dev.json \
          --parameters tenantId=${{ secrets.AZURE_TENANT_ID }} \
          --parameters clientId=${{ secrets.TEAMBOOST_CLIENT_ID }} \
          --name $DEPLOYMENT_NAME

        # Get outputs
        WEB_APP_URL=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.webAppUrl.value" -o tsv)

        WEB_APP_NAME=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.webAppName.value" -o tsv)

        KEY_VAULT_NAME=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.keyVaultName.value" -o tsv)

        echo "web-app-url=$WEB_APP_URL" >> $GITHUB_OUTPUT
        echo "web-app-name=$WEB_APP_NAME" >> $GITHUB_OUTPUT
        echo "key-vault-name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT

    - name: Store Client Secret in Key Vault
      run: |
        az keyvault secret set \
          --vault-name ${{ steps.deploy-infra.outputs.key-vault-name }} \
          --name entra-client-secret \
          --value "${{ secrets.TEAMBOOST_CLIENT_SECRET }}"

    - name: Build and Deploy Team-Boost Application
      env:
        NODE_ENV: development
        ENVIRONMENT: dev
      run: |
        # Install dependencies
        npm ci

        # Build the Team-Boost application
        npm run build

        # Create deployment package for Next.js 16 App Router
        mkdir -p deployment

        # Copy Next.js build output
        if [[ -d ".next/standalone" ]]; then
          # Standalone build (preferred for App Service)
          cp -r .next/standalone/* deployment/
          cp -r .next/static deployment/.next/
        else
          # Standard build fallback
          cp -r .next deployment/
          cp package*.json deployment/
        fi

        # Copy public assets and config
        [[ -d "public" ]] && cp -r public deployment/
        [[ -f "next.config.ts" ]] && cp next.config.ts deployment/

        # Create startup script
        cat > deployment/startup.sh << 'EOF'
        #!/bin/bash
        cd /home/site/wwwroot
        if [ -f "server.js" ]; then
          node server.js
        else
          npm install --production
          npm start
        fi
        EOF
        chmod +x deployment/startup.sh

        # Create ZIP for deployment
        cd deployment
        zip -r ../teamboost-app.zip . > /dev/null
        cd ..

        # Deploy to App Service
        az webapp deployment source config-zip \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_DEV }} \
          --name ${{ steps.deploy-infra.outputs.web-app-name }} \
          --src teamboost-app.zip

    - name: Display Deployment Info
      run: |
        echo "ðŸš€ Team-Boost Development deployment completed!"
        echo "Web App URL: ${{ steps.deploy-infra.outputs.web-app-url }}"
        echo "App Service: ${{ steps.deploy-infra.outputs.web-app-name }}"
        echo "Key Vault: ${{ steps.deploy-infra.outputs.key-vault-name }}"
        echo ""
        echo "ðŸ“‹ Next steps:"
        echo "1. Update your Microsoft Entra ID app registration:"
        echo "   - Redirect URI: ${{ steps.deploy-infra.outputs.web-app-url }}/api/auth/callback/microsoft-entra-id"
        echo "   - Logout URL: ${{ steps.deploy-infra.outputs.web-app-url }}"
        echo "2. Test the Team-Boost application and authentication flow"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: Checkout Team-Boost code
      uses: actions/checkout@v4

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
          --location "${{ env.AZURE_LOCATION }}" \
          --tags Environment=prod Application=team-boost ManagedBy=GitHub-Actions

    - name: Deploy Infrastructure
      id: deploy-infra
      run: |
        cd infrastructure/bicep_v2
        DEPLOYMENT_NAME="teamboost-prod-deployment-$(date +%Y%m%d-%H%M%S)"

        az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
          --template-file main.bicep \
          --parameters @parameters.prod.json \
          --parameters tenantId=${{ secrets.AZURE_TENANT_ID }} \
          --parameters clientId=${{ secrets.TEAMBOOST_CLIENT_ID }} \
          --name $DEPLOYMENT_NAME

        # Get outputs
        WEB_APP_URL=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.webAppUrl.value" -o tsv)

        WEB_APP_NAME=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.webAppName.value" -o tsv)

        KEY_VAULT_NAME=$(az deployment group show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
          --name $DEPLOYMENT_NAME \
          --query "properties.outputs.keyVaultName.value" -o tsv)

        echo "web-app-url=$WEB_APP_URL" >> $GITHUB_OUTPUT
        echo "web-app-name=$WEB_APP_NAME" >> $GITHUB_OUTPUT
        echo "key-vault-name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT

    - name: Store Client Secret in Key Vault
      run: |
        az keyvault secret set \
          --vault-name ${{ steps.deploy-infra.outputs.key-vault-name }} \
          --name entra-client-secret \
          --value "${{ secrets.TEAMBOOST_CLIENT_SECRET }}"

    - name: Build and Deploy Team-Boost Application
      env:
        NODE_ENV: production
        ENVIRONMENT: prod
      run: |
        # Install dependencies
        npm ci

        # Build the Team-Boost application
        npm run build

        # Create deployment package for Next.js 16 App Router
        mkdir -p deployment

        # Copy Next.js build output
        if [[ -d ".next/standalone" ]]; then
          # Standalone build (preferred for App Service)
          cp -r .next/standalone/* deployment/
          cp -r .next/static deployment/.next/
        else
          # Standard build fallback
          cp -r .next deployment/
          cp package*.json deployment/
        fi

        # Copy public assets and config
        [[ -d "public" ]] && cp -r public deployment/
        [[ -f "next.config.ts" ]] && cp next.config.ts deployment/

        # Create startup script
        cat > deployment/startup.sh << 'EOF'
        #!/bin/bash
        cd /home/site/wwwroot
        if [ -f "server.js" ]; then
          node server.js
        else
          npm install --production
          npm start
        fi
        EOF
        chmod +x deployment/startup.sh

        # Create ZIP for deployment
        cd deployment
        zip -r ../teamboost-app.zip . > /dev/null
        cd ..

        # Deploy to App Service
        az webapp deployment source config-zip \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
          --name ${{ steps.deploy-infra.outputs.web-app-name }} \
          --src teamboost-app.zip

    - name: Display Deployment Info
      run: |
        echo "ðŸš€ Team-Boost Production deployment completed!"
        echo "Web App URL: ${{ steps.deploy-infra.outputs.web-app-url }}"
        echo "App Service: ${{ steps.deploy-infra.outputs.web-app-name }}"
        echo "Key Vault: ${{ steps.deploy-infra.outputs.key-vault-name }}"
        echo ""
        echo "ðŸ“‹ Production checklist:"
        echo "1. Update Microsoft Entra ID app registration with production URLs"
        echo "2. Configure custom domain if needed"
        echo "3. Set up monitoring alerts"
        echo "4. Test all Team-Boost features in production"

  manual-deploy:
    name: Manual Environment Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment == 'dev' && 'development' || 'production' }}

    steps:
    - name: Checkout Team-Boost code
      uses: actions/checkout@v4

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Set Environment Variables
      run: |
        if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
          echo "RESOURCE_GROUP=${{ env.AZURE_RESOURCE_GROUP_PROD }}" >> $GITHUB_ENV
        else
          echo "RESOURCE_GROUP=${{ env.AZURE_RESOURCE_GROUP_DEV }}" >> $GITHUB_ENV
        fi

    - name: Deploy Team-Boost
      run: |
        ./infrastructure/scripts/deploy-infrastructure.sh ${{ github.event.inputs.environment }} ${{ env.RESOURCE_GROUP }}

        # Get the app name from deployment
        APP_NAME=$(az webapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)

        if [[ -n "$APP_NAME" ]]; then
          ./infrastructure/scripts/deploy-app.sh ${{ github.event.inputs.environment }} ${{ env.RESOURCE_GROUP }} $APP_NAME
        fi